<!DOCTYPE html>
<html lang="zh-tw">
<head>
    <meta charset="utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<!--Description-->



    <meta name="description" content="MIT &#39;23, Computer Sceince"/>


<!--Author-->

    <meta name="author" content="Utaha"/>


<!--Open Graph Title-->

    <meta property="og:title" content="CSAW CTF Final 2021"/>


<!--Open Graph Description-->

    <meta property="og:description" content="MIT &#39;23, Computer Sceince"/>


<!--Open Graph Site Name-->
    <meta property="og:site_name" content="Utaha&#39;s CTF Note"/>

<!--Type page-->

    <meta property="og:type" content="article"/>


<!--Page Cover-->


    <meta property="og:image" content="https://utaha1228.github.io/ctf-note/img/home-bg.jpg"/>


<meta name="twitter:card" content="summary_large_image"/>




    <meta name="twitter:image" content="https://utaha1228.github.io/ctf-note/img/home-bg.jpg"/>


<!-- Title -->

<title>CSAW CTF Final 2021 | Utaha&#39;s CTF Note</title>

<!-- Bootstrap Core CSS -->
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css">

<!-- Custom CSS -->

<link rel="stylesheet" href="/ctf-note/css/main.css">


<!-- Custom Fonts -->
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.0/css/all.min.css" />
<link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.0/css/all.min.css" />
<link href="//fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
<link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/>

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<!-- Gallery -->
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/featherlight@1.4.0/src/featherlight.css" integrity="sha256-30DV/STftlyQ6v8yaOWlabammvCYtRJERLj/m0b3zno=" crossorigin="anonymous">
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/lightgallery@1.6.11/dist/css/lightgallery.min.css">

<!-- favicon -->

<link rel="icon" href="/ctf-note/img/favicon.png"/>



    <!-- Google Analytics -->
    


<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"></head>
<!-- Head tag -->

<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top bg-transparent position-absolute w-100 p-0" id="nav">
    <div class="container pl-0 pr-0">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <a class="navbar-brand text-white p-1 pl-3" href="/ctf-note/">Utaha's CTF Note</a>
        </div>
        <div>
            <!--  -->
            
                <li class="list-inline-item">
                    <!-- 
                     -->
                    <a class = "navbar-list text-white p-1 pl-3" style = "text-decoration: none;" href="/ctf-note/">
                        
                            Home
                        
                    </a>
                </li>
            
                <li class="list-inline-item">
                    <!-- 
                        <span class="copyright-split">&nbsp;|&nbsp;</span>
                    
                     -->
                    <a class = "navbar-list text-white p-1 pl-3" style = "text-decoration: none;" href="/ctf-note/archives">
                        
                            Archives
                        
                    </a>
                </li>
            
                <li class="list-inline-item">
                    <!-- 
                        <span class="copyright-split">&nbsp;|&nbsp;</span>
                    
                     -->
                    <a class = "navbar-list text-white p-1 pl-3" style = "text-decoration: none;" href="/ctf-note/tags/writeup">
                        
                            Tags
                        
                    </a>
                </li>
            
                <li class="list-inline-item">
                    <!-- 
                        <span class="copyright-split">&nbsp;|&nbsp;</span>
                    
                     -->
                    <a class = "navbar-list text-white p-1 pl-3" style = "text-decoration: none;" href="/ctf-note/about">
                        
                            About
                        
                    </a>
                </li>
            
        </div>
        <div class="navbar-nav float-right">
            <button class="btn btn-link search-btn navbar-item" data-toggle="modal" data-target="#searchModal">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/ctf-note/img/home-bg.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-12 col-md-12 text-center">
                <div class="post-heading text-white">
                    <h1>CSAW CTF Final 2021</h1>
                    
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <!-- Post Main Content -->
            <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1">
                
                    <span class="meta d-inline-block">
    
    
    <!-- Date -->
    
        <span class="post-meta-split">&nbsp;|&nbsp;</span>
        <i class="far fa-calendar-check fa-fw"></i>
        2021-11-14
    
    <!-- word count and read count -->
    

    

    
        <span class="post-meta-split">&nbsp;|&nbsp;</span>
        <i class="far fa-eye fa-fw"></i>
        <span id="busuanzi_value_page_pv"></span>
    
</span>  
                
                <h2 id="intro">Intro</h2>
<p>I played with the team Techsec, the MIT CTF team. Not surprisingly, I'm the only crypto player. I solved 4 out of 5 cryptos, the only unsolve requires certain reversing skill so I just skipped it. The first one is naive, so here's the other 3.</p>
<h2 id="ibad">iBad</h2>
<h3 id="challenge">Challenge</h3>
<p>I don't really know rust, so I attach part of the code and hopefully it makes things clear. There's a webpage which give us a cookie when we give the username as an input. The cookie is generated by encrypting <code>username + '|regular|' + FLAG</code> with AES-GCM with random nonce. There's also an oracle that decrypt our input and check if the plaintext contains '|admin|', it can either decrypt by AES-GCM mode or AES-CBC mode.</p>
<p>The oracle: <figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[rocket::async_trait]</span></span><br><span class="line"><span class="keyword">impl</span>&lt;<span class="symbol">&#x27;r</span>&gt; FromRequest&lt;<span class="symbol">&#x27;r</span>&gt; <span class="keyword">for</span> Admin &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Error</span></span> = &amp;<span class="symbol">&#x27;static</span> <span class="built_in">str</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">fn</span> <span class="title">from_request</span></span>(req: &amp;<span class="symbol">&#x27;r</span> Request&lt;<span class="symbol">&#x27;_</span>&gt;) -&gt; Outcome&lt;<span class="keyword">Self</span>, Self::Error&gt; &#123;</span><br><span class="line">        <span class="keyword">match</span> req.cookies().get(<span class="string">&quot;auth&quot;</span>) &#123;</span><br><span class="line">            <span class="literal">Some</span>(auth) =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> parts = auth.value().split(<span class="string">&quot;.&quot;</span>).collect::&lt;<span class="built_in">Vec</span>&lt;&amp;<span class="built_in">str</span>&gt;&gt;();</span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut</span> decrypted = <span class="keyword">match</span> parts.len() &#123;</span><br><span class="line">                    <span class="number">2</span> =&gt; &#123; <span class="comment">// Legacy path</span></span><br><span class="line">                        <span class="keyword">let</span> iv = base64::decode(parts[<span class="number">0</span>]).unwrap();</span><br><span class="line">                        <span class="keyword">let</span> ciphertext = base64::decode(parts[<span class="number">1</span>]).unwrap();</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">let</span> cipher = Aes128Cbc::new_from_slices(SECRET_KEY.as_ref(), &amp;iv).unwrap();</span><br><span class="line"></span><br><span class="line">                        cipher.decrypt_vec(ciphertext.as_ref()).unwrap()</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="number">3</span> =&gt; &#123; <span class="comment">// Upgraded encryption</span></span><br><span class="line">                        <span class="keyword">let</span> key = aes_gcm::Key::from_slice(SECRET_KEY);</span><br><span class="line">                        <span class="keyword">let</span> cipher = aes_gcm::Aes128Gcm::new(key);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">let</span> tag_raw = base64::decode(parts[<span class="number">0</span>]).unwrap();</span><br><span class="line">                        <span class="keyword">let</span> tag = aes_gcm::Tag::from_slice(tag_raw.as_slice());</span><br><span class="line">                        <span class="keyword">let</span> nonce_raw = base64::decode(parts[<span class="number">1</span>]).unwrap();</span><br><span class="line">                        <span class="keyword">let</span> nonce = aes_gcm::Nonce::from_slice(nonce_raw.as_slice());</span><br><span class="line">                        <span class="keyword">let</span> <span class="keyword">mut</span> plaintext = base64::decode(parts[<span class="number">2</span>]).unwrap();</span><br><span class="line"></span><br><span class="line">                        cipher.decrypt_in_place_detached(nonce, <span class="string">b&quot;&quot;</span>, plaintext.as_mut_slice(), tag).unwrap();</span><br><span class="line">                        plaintext</span><br><span class="line">                    &#125;,</span><br><span class="line">                    _ =&gt; <span class="keyword">return</span> Outcome::Failure((rocket::http::Status::Unauthorized, <span class="string">&quot;invalid cookie format&quot;</span>))</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="number">0</span>..decrypted.len() &#123;</span><br><span class="line">                    <span class="keyword">if</span> decrypted.starts_with(<span class="string">b&quot;|admin|&quot;</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> Outcome::Success(Admin());</span><br><span class="line">                    &#125;</span><br><span class="line">                    decrypted.rotate_left(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                Outcome::Forward(())</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="literal">None</span> =&gt; Outcome::Failure((rocket::http::Status::Unauthorized, <span class="string">&quot;No cookie&quot;</span>))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>The cookie generator: <figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[post(<span class="meta-string">&quot;/login&quot;</span>, data=<span class="meta-string">&quot;&lt;data&gt;&quot;</span>)]</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">login_submit</span></span>(data: Form&lt;LoginData&lt;<span class="symbol">&#x27;_</span>&gt;&gt;, cookies: &amp;rocket::http::CookieJar&lt;<span class="symbol">&#x27;_</span>&gt;) -&gt; rocket::response::Redirect &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> key = aes_gcm::Key::from_slice(SECRET_KEY);</span><br><span class="line">    <span class="keyword">let</span> cipher = aes_gcm::Aes128Gcm::new(key);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> nonce_raw: [<span class="built_in">u8</span>; <span class="number">12</span>] = [<span class="number">0</span>; <span class="number">12</span>];</span><br><span class="line">    <span class="keyword">let</span> _ = getrandom(&amp;<span class="keyword">mut</span> nonce_raw).unwrap();</span><br><span class="line">    <span class="keyword">let</span> nonce = aes_gcm::Nonce::from_slice(&amp;nonce_raw);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> ciphertext = <span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125;|regular|&#123;&#125;&quot;</span>, data.username, FLAG).bytes().collect::&lt;<span class="built_in">Vec</span>&lt;<span class="built_in">u8</span>&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> tag = cipher.encrypt_in_place_detached(nonce, <span class="string">b&quot;&quot;</span>, ciphertext.as_mut_slice()).unwrap();</span><br><span class="line"></span><br><span class="line">    cookies.add(rocket::http::Cookie::new(<span class="string">&quot;auth&quot;</span>, <span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125;.&#123;&#125;.&#123;&#125;&quot;</span>, base64::encode(tag), base64::encode(nonce), base64::encode(ciphertext))));</span><br><span class="line">    Redirect::to(uri!(profile()))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="solution">Solution</h3>
<p>It turned out that we only need the CTR mode ciphertext (from GCM mode), and the CBC decryption oracle to recover the flag. The idea is that CTR mode is like a one-time pad, with the keystream generated by the AES output of the nonce. With the cookie, we have the ciphertext and the plaintext (except the last 51 bytes of flag), so we can get the prefix of the keystream. Suppose we have the first 15 bytes of the keystream, we can recover the 16th byte by bruteforcing all possibilities and sending the speculated keystream to the CBC decryption, and see if it decrypts to the nonce.</p>
<p>Here's the more detailed explanation. If we want to recover the first character of the flag, we choose the username to be several 'A's, so that the plaintext will be <code>'A...AA|regular|FLAG'</code>, and the first byte of the flag should be the last byte of a block. With this username, we have the ciphertext for <code>'AA...AA|regular|*'</code> (<code>*</code> is the unknown byte), so the keystream, which is the AES output of <code>nonce + b'\x00\x00\x00\x02</code>, is the xor value of the plaintext and the ciphertext. However, the last byte is unknown, so we iterate all possibilities and send the keystream to CBC oracle. Setting initial value to be <code>nonce + b'\x00\x00\x00\x02'</code> xor with <code>b'AA...AA|admin|\x01</code>, the decryption in CBC mode will be <code>b'AA...AA|admin|</code> if we get the correct ciphertext and directs us to the admin page. The last <code>\x01</code> byte is due to PKCS#7 padding.</p>
<p>We can similarly do the same trick with other bytes. The following is the solve script.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes, bytes_to_long</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line">FLAG_LEN = <span class="number">51</span></span><br><span class="line">url = <span class="string">&#x27;http://crypto.chal.csaw.io:5015&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">isAdmin</span>(<span class="params">cookies</span>):</span></span><br><span class="line">    s = requests.Session()</span><br><span class="line">    s.cookies.<span class="built_in">set</span>(<span class="string">&quot;auth&quot;</span>, cookies)</span><br><span class="line">    r = s.get(url + <span class="string">&#x27;/profile&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> r.status_code != <span class="number">200</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;error&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;Admin Profile&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;admin&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;regular&#x27;</span>    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getCookie</span>(<span class="params">username, debug = <span class="literal">False</span></span>):</span></span><br><span class="line">    s = requests.Session()</span><br><span class="line">    r = s.post(url + <span class="string">&#x27;/login&#x27;</span>, data = &#123;<span class="string">&quot;username&quot;</span>: username&#125;)</span><br><span class="line">    s.close()</span><br><span class="line">    <span class="keyword">return</span> s.cookies[<span class="string">&#x27;auth&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encodeCookie</span>(<span class="params">cookie</span>):</span></span><br><span class="line">    <span class="keyword">return</span> cookie.replace(<span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;%3D&#x27;</span>).replace(<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;%2F&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decodeCookie</span>(<span class="params">cookie</span>):</span></span><br><span class="line">    <span class="keyword">return</span> cookie.replace(<span class="string">&#x27;%3D&#x27;</span>, <span class="string">&#x27;=&#x27;</span>).replace(<span class="string">&#x27;%2F&#x27;</span>, <span class="string">&#x27;/&#x27;</span>)</span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(FLAG_LEN): <span class="comment"># recover the flag one byte by one byte</span></span><br><span class="line">    username = <span class="string">&#x27;A&#x27;</span> * (<span class="number">16</span> - (<span class="built_in">len</span>(<span class="string">&#x27;|regular|&#x27;</span>) + i + <span class="number">1</span>) % <span class="number">16</span>)</span><br><span class="line">    INPUT = <span class="string">f&#x27;<span class="subst">&#123;username&#125;</span>|regular|<span class="subst">&#123;flag&#125;</span>*&#x27;</span> <span class="comment"># * is the current unknown bytes</span></span><br><span class="line">    blockIndex = <span class="built_in">len</span>(INPUT) // <span class="number">16</span> - <span class="number">1</span></span><br><span class="line">    _, nonce, ct = <span class="built_in">map</span>(base64.b64decode, decodeCookie(getCookie(username)).split(<span class="string">&#x27;.&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    block = nonce + long_to_bytes(blockIndex + <span class="number">2</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    ct = ct[blockIndex * <span class="number">16</span>: blockIndex * <span class="number">16</span> + <span class="number">16</span>]</span><br><span class="line">    pt = INPUT[-<span class="number">16</span>:].encode()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Ciphertext of nonce, but the last byte is wrong</span></span><br><span class="line">    block_output = [x ^ y <span class="keyword">for</span> x, y <span class="keyword">in</span> <span class="built_in">zip</span>(ct, pt)]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> tqdm(<span class="built_in">range</span>(<span class="number">256</span>)):</span><br><span class="line">        iv = <span class="built_in">bytes</span>([x ^ y <span class="keyword">for</span> x, y <span class="keyword">in</span> <span class="built_in">zip</span>(block, <span class="string">b&#x27;AAAAAAAA|admin|\x01&#x27;</span>)])</span><br><span class="line">        block_output[-<span class="number">1</span>] = c</span><br><span class="line">        cookie = base64.b64encode(iv) + <span class="string">b&#x27;.&#x27;</span> + base64.b64encode(<span class="built_in">bytes</span>(block_output))</span><br><span class="line">        cookie = encodeCookie(cookie.decode(<span class="string">&#x27;ascii&#x27;</span>))</span><br><span class="line">        <span class="keyword">if</span> isAdmin(cookie) == <span class="string">&#x27;admin&#x27;</span>:</span><br><span class="line">            pt = <span class="built_in">bytes</span>([x ^ y <span class="keyword">for</span> x, y <span class="keyword">in</span> <span class="built_in">zip</span>(block_output, ct)]).decode(<span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">            flag += pt[-<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>
<h2 id="interoperable">Interoperable</h2>
<h3 id="challenge-1">Challenge</h3>
<p>The problem asks us to choose the curve (out of NIST-P256 and secp256k1), and a base point <code>G</code>. Then we have to solve a discrete log problem.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> ceil, sqrt, gcd, lcm</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> mpz</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># Remove</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(os.path.abspath(os.path.dirname(__file__)), <span class="string">&quot;flag.txt&quot;</span>)) <span class="keyword">as</span> f:</span><br><span class="line">    FLAG = f.read().strip()</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">=====================================</span></span><br><span class="line"><span class="string">      Elliptic Curve Arithmetic</span></span><br><span class="line"><span class="string">=====================================</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a simple Point class to represent the affine points.</span></span><br><span class="line">Point = namedtuple(<span class="string">&quot;Point&quot;</span>, <span class="string">&quot;x y&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># The point at infinity (origin for the group law).</span></span><br><span class="line">O = <span class="string">&#x27;Origin&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Here&#x27;s a choice of curves. They both offer 128-bit security</span></span><br><span class="line"><span class="comment"># so it doesnt matter to me!</span></span><br><span class="line">curve_p256 = &#123;</span><br><span class="line">    <span class="string">&quot;p&quot;</span>: mpz(<span class="number">2</span>**<span class="number">256</span> - <span class="number">2</span>**<span class="number">224</span> + <span class="number">2</span>**<span class="number">192</span> + <span class="number">2</span>**<span class="number">96</span> - <span class="number">1</span>),</span><br><span class="line">    <span class="string">&quot;a&quot;</span>: mpz(-<span class="number">0x3</span>),</span><br><span class="line">    <span class="string">&quot;b&quot;</span>: mpz(<span class="number">0x5ac635d8aa3a93e7b3ebbd55769886bc651d06b0cc53b0f63bce3c3e27d2604b</span>),</span><br><span class="line">    <span class="string">&quot;n&quot;</span>: mpz(<span class="number">0xffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">curve_s256 = &#123;</span><br><span class="line">    <span class="string">&quot;p&quot;</span>: mpz(<span class="number">2</span>**<span class="number">256</span> - <span class="number">2</span>**<span class="number">32</span> - <span class="number">977</span>),</span><br><span class="line">    <span class="string">&quot;a&quot;</span>: mpz(<span class="number">0x0</span>),</span><br><span class="line">    <span class="string">&quot;b&quot;</span>: mpz(<span class="number">0x7</span>),</span><br><span class="line">    <span class="string">&quot;n&quot;</span>: mpz(<span class="number">0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_point</span>(<span class="params">P, curve</span>):</span></span><br><span class="line">    p, a, b = curve[<span class="string">&quot;p&quot;</span>], curve[<span class="string">&quot;a&quot;</span>], curve[<span class="string">&quot;b&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> P == O:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> (P.y**<span class="number">2</span> - (P.x**<span class="number">3</span> + a*P.x + b)) % p == <span class="number">0</span> <span class="keyword">and</span> <span class="number">0</span> &lt;= P.x &lt; p <span class="keyword">and</span> <span class="number">0</span> &lt;= P.y &lt; p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">point_inverse</span>(<span class="params">P, curve</span>):</span></span><br><span class="line">    p = curve[<span class="string">&quot;p&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> P == O:</span><br><span class="line">        <span class="keyword">return</span> P</span><br><span class="line">    <span class="keyword">return</span> Point(P.x, -P.y % p)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">point_addition</span>(<span class="params">P, Q, curve</span>):</span></span><br><span class="line">    p, a, b = curve[<span class="string">&quot;p&quot;</span>], curve[<span class="string">&quot;a&quot;</span>], curve[<span class="string">&quot;b&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> P == O:</span><br><span class="line">        <span class="keyword">return</span> Q</span><br><span class="line">    <span class="keyword">elif</span> Q == O:</span><br><span class="line">        <span class="keyword">return</span> P</span><br><span class="line">    <span class="keyword">elif</span> Q == point_inverse(P, curve):</span><br><span class="line">        <span class="keyword">return</span> O</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> P == Q:</span><br><span class="line">            lam = (<span class="number">3</span>*P.x**<span class="number">2</span> + a) * <span class="built_in">pow</span>(<span class="number">2</span>*P.y, -<span class="number">1</span>, p)</span><br><span class="line">            lam %= p</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            lam = (Q.y - P.y) * <span class="built_in">pow</span>((Q.x - P.x), -<span class="number">1</span>, p)</span><br><span class="line">            lam %= p</span><br><span class="line">    Rx = (lam**<span class="number">2</span> - P.x - Q.x) % p</span><br><span class="line">    Ry = (lam*(P.x - Rx) - P.y) % p</span><br><span class="line">    R = Point(Rx, Ry)</span><br><span class="line">    <span class="keyword">return</span> R</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">double_and_add</span>(<span class="params">P, n, curve</span>):</span></span><br><span class="line">    Q = P</span><br><span class="line">    R = O</span><br><span class="line">    <span class="keyword">while</span> n &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> n % <span class="number">2</span> == <span class="number">1</span>:</span><br><span class="line">            R = point_addition(R, Q, curve)</span><br><span class="line">        Q = point_addition(Q, Q, curve)</span><br><span class="line">        n = n // <span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> R</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">=====================================</span></span><br><span class="line"><span class="string">           Util Functions</span></span><br><span class="line"><span class="string">=====================================</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recv_json</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Parse user input, expecting it as valid json</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> json.loads(<span class="built_in">input</span>(<span class="string">&quot;&gt; &quot;</span>))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        exit(<span class="string">&quot;Please send data as json using the expected format&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recv_curve</span>(<span class="params">resp</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Pick to set the challenge over one of two prime </span></span><br><span class="line"><span class="string">    order curves:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    curve_p256: NIST-P256</span></span><br><span class="line"><span class="string">    curve_s256: secp256k1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Expected format: </span></span><br><span class="line"><span class="string">    &#123;&quot;curve&quot; : &quot;curve_name&quot;&#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    chosen_curve = resp[<span class="string">&quot;curve&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> chosen_curve == <span class="string">&quot;curve_s256&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> curve_s256</span><br><span class="line">    <span class="keyword">elif</span> chosen_curve == <span class="string">&quot;curve_p256&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> curve_p256</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        exit(<span class="string">&quot;Sorry, only our chosen prime order curves are allowed.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recv_generator</span>(<span class="params">resp, curve</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Receive a point on the curve to use as a generator.</span></span><br><span class="line"><span class="string">    Our curves are prime order, so any point will do!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Expected format: </span></span><br><span class="line"><span class="string">    &#123;&quot;Gx&quot; : &quot;0x1337cafe&quot;, &quot;Gy&quot; : &quot;0xc0ffee&quot;&#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    Gx = mpz(<span class="built_in">int</span>(resp[<span class="string">&quot;Gx&quot;</span>], <span class="number">16</span>))</span><br><span class="line">    Gy = mpz(<span class="built_in">int</span>(resp[<span class="string">&quot;Gy&quot;</span>], <span class="number">16</span>))</span><br><span class="line">    G = Point(Gx, Gy)</span><br><span class="line">    <span class="keyword">assert</span> check_point(G, curve), <span class="string">&quot;Whoops! Maybe you made a typo?&quot;</span></span><br><span class="line">    <span class="keyword">return</span> G</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recv_secret</span>(<span class="params">resp</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Can you solve the discrete log problem?</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Expected format: </span></span><br><span class="line"><span class="string">    &#123;&quot;d&quot; : &quot;0x123456789&quot;&#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(resp[<span class="string">&quot;d&quot;</span>], <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">=====================================</span></span><br><span class="line"><span class="string">             Challenge</span></span><br><span class="line"><span class="string">=====================================</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">public_key</span>(<span class="params">G, curve</span>):</span></span><br><span class="line">    d = random.randint(<span class="number">1</span>, curve[<span class="string">&quot;n&quot;</span>])</span><br><span class="line">    <span class="keyword">return</span> d, double_and_add(G, d, curve)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify</span>(<span class="params">G, Q, d, curve</span>):</span></span><br><span class="line">    <span class="keyword">return</span> double_and_add(G, d, curve) == Q</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    curve = <span class="literal">None</span></span><br><span class="line">    G = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        resp = recv_json()</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;curve&quot;</span> <span class="keyword">in</span> resp:</span><br><span class="line">            curve = recv_curve(resp)</span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&quot;Gx&quot;</span> <span class="keyword">in</span> resp <span class="keyword">and</span> <span class="string">&quot;Gy&quot;</span> <span class="keyword">in</span> resp:</span><br><span class="line">            <span class="keyword">assert</span> curve <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line">            G = recv_generator(resp, curve)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> curve <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">assert</span> G <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Generating challenge...&quot;</span>)</span><br><span class="line">    d, Q = public_key(G, curve)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Challenge: <span class="subst">&#123;Q&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;What&#x27;s my secret?&quot;</span>)</span><br><span class="line">    resp = recv_json()</span><br><span class="line">    d_guess = recv_secret(resp)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> verify(G, Q, d_guess, curve):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;What?!? I guess we better start moving to PQ-Crypto!&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Flag: <span class="subst">&#123;FLAG&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        exit(<span class="string">&quot;Don&#x27;t be too tough on yourself, there are a lot of secrets to guess from...&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="solution-1">Solution</h3>
<p>Choose curve: <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    resp = recv_json()</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;curve&quot;</span> <span class="keyword">in</span> resp:</span><br><span class="line">        curve = recv_curve(resp)</span><br><span class="line">    <span class="keyword">elif</span> <span class="string">&quot;Gx&quot;</span> <span class="keyword">in</span> resp <span class="keyword">and</span> <span class="string">&quot;Gy&quot;</span> <span class="keyword">in</span> resp:</span><br><span class="line">        <span class="keyword">assert</span> curve <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line">        G = recv_generator(resp, curve)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></figure> Discrete log problem: <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify</span>(<span class="params">G, Q, d, curve</span>):</span></span><br><span class="line">    <span class="keyword">return</span> double_and_add(G, d, curve) == Q</span><br></pre></td></tr></table></figure></p>
<p>We can change the curve after we choose the point, which is a sign of invalid curve attack.</p>
<p>As the first attempt, I choose a point from NIST-P256, and see if changing the curve to secp256k1 makes the discrete log easier. The invalid point on secp256k1 acts on the same <span class="math inline">\(p\)</span> and <span class="math inline">\(a\)</span>, but the constant term <span class="math inline">\(b\)</span> changes. If the result elliptic curve has a smooth order then we are done. However, it's not that easy to make it happen.</p>
<p>I start to try to find special point – if <span class="math inline">\(y = 0\)</span>, then the order is 2, but the curve has no such point, or the order is an even number, not a prime. Then it came to my mind that if <span class="math inline">\(a = 0\)</span>, then the point such that <span class="math inline">\(x = 0\)</span> has order 3, and secp256k1 does satisfy <span class="math inline">\(a = 0\)</span>, so now the attack is really clear: choose curve NISTP256, choose point that <span class="math inline">\(x = 0\)</span>, change the curve to secp256k1. At the end, the order of the point is 3, and solving the discrete log is easy. It takes only a few minutes to code everything.</p>
<p>The script: <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">conn = remote(<span class="string">&#x27;crypto.chal.csaw.io&#x27;</span>, <span class="number">5017</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_json</span>(<span class="params">j</span>):</span></span><br><span class="line">    conn.sendline(json.dumps(j))</span><br><span class="line"></span><br><span class="line">Gx = <span class="number">0</span></span><br><span class="line">Gy = <span class="number">69528327468847610065686496900697922508397251637412376320436699849860351814667</span></span><br><span class="line"></span><br><span class="line">send_json(&#123;<span class="string">&quot;curve&quot;</span>:<span class="string">&quot;curve_p256&quot;</span>&#125;)</span><br><span class="line">send_json(&#123;<span class="string">&quot;Gx&quot;</span>: <span class="built_in">hex</span>(Gx), <span class="string">&quot;Gy&quot;</span>: <span class="built_in">hex</span>(Gy)&#125;)</span><br><span class="line">send_json(&#123;<span class="string">&quot;curve&quot;</span>:<span class="string">&quot;curve_s256&quot;</span>&#125;)</span><br><span class="line">send_json(&#123;<span class="string">&quot;OwO&quot;</span>: <span class="string">&quot;OAO&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">conn.recvuntil(<span class="string">b&#x27;y=mpz(&#x27;</span>)</span><br><span class="line">y = <span class="built_in">int</span>(conn.recvline().strip()[:-<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">p2 = <span class="number">2</span>**<span class="number">256</span> - <span class="number">2</span>**<span class="number">32</span> - <span class="number">977</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> y == Gy:</span><br><span class="line">    send_json(&#123;<span class="string">&quot;d&quot;</span>: <span class="built_in">hex</span>(<span class="number">1</span>)&#125;)</span><br><span class="line"><span class="keyword">elif</span> y == -Gy % p2:</span><br><span class="line">    send_json(&#123;<span class="string">&quot;d&quot;</span>: <span class="built_in">hex</span>(<span class="number">2</span>)&#125;)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    send_json(&#123;<span class="string">&quot;d&quot;</span>: <span class="built_in">hex</span>(<span class="number">3</span>)&#125;)</span><br><span class="line"></span><br><span class="line">conn.interactive()</span><br></pre></td></tr></table></figure></p>
<h2 id="abolish-tables">aBoLiSh taBLeS</h2>
<h3 id="challenge-2">Challenge</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">==================================</span></span><br><span class="line"><span class="string">  Global parameters for protocol</span></span><br><span class="line"><span class="string">==================================</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(os.path.abspath(os.path.dirname(__file__)), <span class="string">&quot;flag.txt&quot;</span>)) <span class="keyword">as</span> f:</span><br><span class="line">    FLAG = f.read().strip()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Safe prime</span></span><br><span class="line">g_commit = <span class="number">0x2</span></span><br><span class="line">p_commit = <span class="number">0x1b1177aadf10a3868443d5b4e6384d914f8c2eb51d1ebec4511d05ed22d8006a65cb4fc0442334e4ad5e2b11cd65cb82efec327d234f034321a818cfc9c71d48f</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># BLS12-381 Parameters</span></span><br><span class="line"><span class="comment"># https://github.com/zkcrypto/bls12_381</span></span><br><span class="line">p = <span class="number">0x1a0111ea397fe69a4b1ba7b6434bacd764774b84f38512bf6730d2a0f6b0f6241eabfffeb153ffffb9feffffffffaaab</span></span><br><span class="line">r = <span class="number">0x73eda753299d7d483339d80809a1d80553bda402fffe5bfeffffffff00000001</span></span><br><span class="line">h1 = <span class="number">0x396c8c005555e1568c00aaab0000aaab</span></span><br><span class="line">h2 = <span class="number">0x5d543a95414e7f1091d50792876a202cd91de4547085abaa68a205b2e5a7ddfa628f1cb4d9e82ef21537e293a6691ae1616ec6e786f0c70cf1c38e31c7238e5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Define base fields</span></span><br><span class="line">F1 = GF(p)</span><br><span class="line">F2.&lt;u&gt; = GF(p^<span class="number">2</span>, x, x^<span class="number">2</span> + <span class="number">1</span>)</span><br><span class="line">F12.&lt;w&gt; = GF(p^<span class="number">12</span>, x, x^<span class="number">12</span> - <span class="number">2</span>*x^<span class="number">6</span> + <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Define the Elliptic Curves</span></span><br><span class="line">E1 = EllipticCurve(F1, [<span class="number">0</span>, <span class="number">4</span>])</span><br><span class="line">E2 = EllipticCurve(F2, [<span class="number">0</span>, <span class="number">4</span>*(<span class="number">1</span> + u)])</span><br><span class="line">E12 = EllipticCurve(F12, [<span class="number">0</span>, <span class="number">4</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># Generator of order r in E1 / F1</span></span><br><span class="line">G1x = <span class="number">0x17f1d3a73197d7942695638c4fa9ac0fc3688c4f9774b905a14e3a3f171bac586c55e83ff97a1aeffb3af00adb22c6bb</span></span><br><span class="line">G1y = <span class="number">0x8b3f481e3aaa0f1a09e30ed741d8ae4fcf5e095d5d00af600db18cb2c04b3edd03cc744a2888ae40caa232946c5e7e1</span></span><br><span class="line">G1 = E1(G1x, G1y)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Generator of order r in E2 / F2</span></span><br><span class="line">G2x0 = <span class="number">0x24aa2b2f08f0a91260805272dc51051c6e47ad4fa403b02b4510b647ae3d1770bac0326a805bbefd48056c8c121bdb8</span></span><br><span class="line">G2x1 = <span class="number">0x13e02b6052719f607dacd3a088274f65596bd0d09920b61ab5da61bbdc7f5049334cf11213945d57e5ac7d055d042b7e</span></span><br><span class="line">G2y0 = <span class="number">0xce5d527727d6e118cc9cdc6da2e351aadfd9baa8cbdd3a76d429a695160d12c923ac9cc3baca289e193548608b82801</span></span><br><span class="line">G2y1 = <span class="number">0x606c4a02ea734cc32acd2b02bc28b99cb3e287e85a763af267492ab572e99ab3f370d275cec1da1aaa9075ff05f79be</span></span><br><span class="line">G2 = E2(G2x0 + u*G2x1, G2y0 + u*G2y1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">==================================</span></span><br><span class="line"><span class="string">       BLS Signature Class</span></span><br><span class="line"><span class="string">==================================</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BLSSign</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.d = randint(<span class="number">2</span>, <span class="number">2</span>^<span class="number">70</span>)</span><br><span class="line">        self.public = self.public()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">lift_E1_to_E12</span>(<span class="params">self, P</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Lift point on E/F_q to E/F_&#123;q^12&#125; using the natural lift</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">assert</span> P.curve() == E1, <span class="string">&quot;Attempting to lift a point from the wrong curve.&quot;</span></span><br><span class="line">        <span class="keyword">return</span> E12(P)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">lift_E2_to_E12</span>(<span class="params">self, P</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Lift point on E/F_&#123;q^2&#125; to E/F_&#123;q_12&#125; through the sextic twist</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">assert</span> P.curve() == E2, <span class="string">&quot;Attempting to lift a point from the wrong curve.&quot;</span></span><br><span class="line">        xs, ys = [c.polynomial().coefficients() <span class="keyword">for</span> c <span class="keyword">in</span> (h2*P).xy()]</span><br><span class="line">        nx = F12(xs[<span class="number">0</span>] - xs[<span class="number">1</span>] + w ^ <span class="number">6</span>*xs[<span class="number">1</span>])</span><br><span class="line">        ny = F12(ys[<span class="number">0</span>] - ys[<span class="number">1</span>] + w ^ <span class="number">6</span>*ys[<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">return</span> E12(nx / (w ^ <span class="number">2</span>), ny / (w ^ <span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">point_to_integer</span>(<span class="params">self, P</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Extracts an integer from a point for</span></span><br><span class="line"><span class="string">        commitment.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> P.is_zero():</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        x,y = P.xy()</span><br><span class="line"></span><br><span class="line">        s = Integer(x.polynomial().coefficients()[<span class="number">0</span>])</span><br><span class="line">        t = Integer(y.polynomial().coefficients()[<span class="number">0</span>])</span><br><span class="line">        n = s &lt;&lt; (t &amp; <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> n</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">public</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.d*G1</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hash</span>(<span class="params">self, i, msg</span>):</span></span><br><span class="line">        m = <span class="built_in">bytes</span>.fromhex(msg)</span><br><span class="line">        <span class="keyword">return</span> hashlib.sha512(<span class="built_in">bytes</span>([i]) + m).hexdigest()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hash_to_point</span>(<span class="params">self, msg</span>):</span></span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        m = <span class="built_in">int</span>(msg, <span class="number">16</span>)</span><br><span class="line">        Hm = self.<span class="built_in">hash</span>(i, msg)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                Hmx = <span class="built_in">int</span>(Hm, <span class="number">16</span>) % p</span><br><span class="line">                <span class="keyword">return</span> m*E2.lift_x(Hmx)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">                i %= <span class="number">256</span></span><br><span class="line">                Hm = self.<span class="built_in">hash</span>(i, Hm)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pairing</span>(<span class="params">self, A, B</span>):</span></span><br><span class="line">        <span class="keyword">return</span> A.ate_pairing(B, r, <span class="number">12</span>, E12.trace_of_frobenius())</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sign</span>(<span class="params">self, msg</span>):</span></span><br><span class="line">        P = self.hash_to_point(msg)</span><br><span class="line">        <span class="keyword">return</span> self.d*P</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">verify</span>(<span class="params">self, msg, sig</span>):</span></span><br><span class="line">        P = self.hash_to_point(msg)</span><br><span class="line">        lhs = self.pairing(self.lift_E1_to_E12(self.public), self.lift_E2_to_E12(P))</span><br><span class="line">        rhs = self.pairing(self.lift_E1_to_E12(G1), self.lift_E2_to_E12(sig))</span><br><span class="line">        <span class="keyword">return</span> lhs == rhs</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">commitment</span>(<span class="params">self, msg</span>):</span></span><br><span class="line">        sig = self.sign(msg)</span><br><span class="line">        x = self.point_to_integer(sig)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">pow</span>(g_commit, x, p_commit)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">==================================</span></span><br><span class="line"><span class="string">  Util functions</span></span><br><span class="line"><span class="string">==================================</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recv_json</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Parse user input, expecting it as valid json</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> json.loads(<span class="built_in">input</span>(<span class="string">&quot;&gt; &quot;</span>))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        exit(<span class="string">&quot;Please send data as json using the expected format.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">commit_to_message</span>(<span class="params">bls</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    To be extra cautious, we will only give users our commitment</span></span><br><span class="line"><span class="string">    to our signatures, we don&#x27;t want people to be able to sign</span></span><br><span class="line"><span class="string">    arbitary messages!</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Please send your message to sign, encoded as a hex string.&quot;</span>)</span><br><span class="line">    resp = recv_json()</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;message&quot;</span> <span class="keyword">in</span> resp:</span><br><span class="line">        msg = resp[<span class="string">&quot;message&quot;</span>]</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">all</span>(</span><br><span class="line">            c <span class="keyword">in</span> string.hexdigits <span class="keyword">for</span> c <span class="keyword">in</span> msg), <span class="string">&quot;Invalid message. Please use hex encoding.&quot;</span></span><br><span class="line">        commitment = bls.commitment(msg)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Our commitment: <span class="subst">&#123;commitment&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;You must send a message to see our commitment.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify_signature</span>(<span class="params">bls</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    We&#x27;ll give a flag to anyone who can supply a valid</span></span><br><span class="line"><span class="string">    signature to the challenge message</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    challenge = <span class="string">b&quot;https://cryptohack.org&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Please send the valid signature for our challenge: &#123;challenge&#125;.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    resp = recv_json()</span><br><span class="line">    expected_coords = [<span class="string">&quot;Sx0&quot;</span>, <span class="string">&quot;Sx1&quot;</span>, <span class="string">&quot;Sy0&quot;</span>, <span class="string">&quot;Sy1&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">all</span>(s <span class="keyword">in</span> resp <span class="keyword">for</span> s <span class="keyword">in</span> expected_coords):</span><br><span class="line">        coords = [<span class="built_in">int</span>(x, <span class="number">16</span>) <span class="keyword">for</span> x <span class="keyword">in</span> resp.values()]</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            sig = E2(coords[<span class="number">0</span>] + u*coords[<span class="number">1</span>], coords[<span class="number">2</span>] + u*coords[<span class="number">3</span>])</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            exit(<span class="string">&quot;You must send a point on the curve E2.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> bls.verify(challenge.<span class="built_in">hex</span>(), sig):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Flag: <span class="subst">&#123;FLAG&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            exit(<span class="string">&quot;Fraudulent signature detected.&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;You must send the x and y coordinates of the signature.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    bls = BLSSign()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Please send an option.&quot;</span>)</span><br><span class="line">        resp = recv_json()</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;option&quot;</span> <span class="keyword">in</span> resp:</span><br><span class="line">            option = resp[<span class="string">&quot;option&quot;</span>]</span><br><span class="line">            <span class="keyword">if</span> option == <span class="string">&quot;sign&quot;</span>:</span><br><span class="line">                commit_to_message(bls)</span><br><span class="line">            <span class="keyword">elif</span> option == <span class="string">&quot;verify&quot;</span>:</span><br><span class="line">                verify_signature(bls)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Invalid option&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Invalid request.\nAvailable options: sign, verify.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="solution-2">Solution</h3>
<p>I'm not really familiar with the pairing, but I found 2 things that look sus: the private key <code>d</code> is small, and the <code>hash_to_point</code> function can lift point to something not actually on E2. If I can somehow control the <code>hash_to_point</code> function, then I can make a point of order 2, order 3, and so on. Solving the discrete log problem + Chinese Remainder Theorem can recover the private key easily. It turned out that I'm pretty much on the right track. The order of E2 (not the subgroup) is <code>r * h2</code>, and <code>h2</code> has several small factors:</p>
<p><span class="math display">\[h_2 = 13^2 \cdot 23^2 \cdot 2713 \cdot 11953 \cdot 262069 \cdots\]</span></p>
<p>So if <code>hash_to_point(msg)</code> has order 2713, then we can get the value of <span class="math inline">\(d \bmod 2713\)</span>. How can we get such message? Notice that at the end of the hash function, they calculate <code>m*E2.lift_x(Hmx)</code>, so it <code>m = r * h2 // 2713</code>, then we get a point of order 2713 with high probability. In the competition, I couldn't find a point of order 169, but only find a point with order 13. Same thing happened for 23, so at the end, solving CRT gives the remainder of <span class="math inline">\(d\)</span> mod</p>
<p><span class="math display">\[13 * 23 * 2713 * 11953 * 262069 \approx 2^{51} \]</span></p>
<p>We are left with roughly <span class="math inline">\(2^{19}\)</span> possibilities, and we can simply bruteforce it. After recover the secret key, we can forge a signature easily.</p>
<p>p.s. during the contest, my code failed several times before getting the flag (without changing anything), I don't know why.</p>
<p>I couldn't run sage and pwntools at the same time, so I run sage to print the list used for getting the reminader, save it to a file, and run python reading that file. The file is 37 MB big.</p>
<p>Sage script for determining the remainder:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">######################################################## Copy-Pasted code</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="comment"># Safe prime</span></span><br><span class="line">g_commit = <span class="number">0x2</span></span><br><span class="line">p_commit = <span class="number">0x1b1177aadf10a3868443d5b4e6384d914f8c2eb51d1ebec4511d05ed22d8006a65cb4fc0442334e4ad5e2b11cd65cb82efec327d234f034321a818cfc9c71d48f</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># BLS12-381 Parameters</span></span><br><span class="line"><span class="comment"># https://github.com/zkcrypto/bls12_381</span></span><br><span class="line">p = <span class="number">0x1a0111ea397fe69a4b1ba7b6434bacd764774b84f38512bf6730d2a0f6b0f6241eabfffeb153ffffb9feffffffffaaab</span></span><br><span class="line">r = <span class="number">0x73eda753299d7d483339d80809a1d80553bda402fffe5bfeffffffff00000001</span></span><br><span class="line">h1 = <span class="number">0x396c8c005555e1568c00aaab0000aaab</span></span><br><span class="line">h2 = <span class="number">0x5d543a95414e7f1091d50792876a202cd91de4547085abaa68a205b2e5a7ddfa628f1cb4d9e82ef21537e293a6691ae1616ec6e786f0c70cf1c38e31c7238e5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Define base fields</span></span><br><span class="line">F1 = GF(p)</span><br><span class="line">F2.&lt;u&gt; = GF(p^<span class="number">2</span>, x, x^<span class="number">2</span> + <span class="number">1</span>)</span><br><span class="line">F12.&lt;w&gt; = GF(p^<span class="number">12</span>, x, x^<span class="number">12</span> - <span class="number">2</span>*x^<span class="number">6</span> + <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Define the Elliptic Curves</span></span><br><span class="line">E1 = EllipticCurve(F1, [<span class="number">0</span>, <span class="number">4</span>])</span><br><span class="line">E2 = EllipticCurve(F2, [<span class="number">0</span>, <span class="number">4</span>*(<span class="number">1</span> + u)])</span><br><span class="line">E12 = EllipticCurve(F12, [<span class="number">0</span>, <span class="number">4</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hash</span>(<span class="params">i, msg</span>):</span></span><br><span class="line">    m = <span class="built_in">bytes</span>.fromhex(msg)</span><br><span class="line">    <span class="keyword">return</span> hashlib.sha512(<span class="built_in">bytes</span>([i]) + m).hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hash_to_point</span>(<span class="params">msg</span>):</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    m = <span class="built_in">int</span>(msg, <span class="number">16</span>)</span><br><span class="line">    Hm = <span class="built_in">hash</span>(i, msg)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            Hmx = <span class="built_in">int</span>(Hm, <span class="number">16</span>) % p</span><br><span class="line">            <span class="keyword">return</span> m*E2.lift_x(Hmx)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">            i %= <span class="number">256</span></span><br><span class="line">            Hm = <span class="built_in">hash</span>(i, Hm)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">point_to_integer</span>(<span class="params">P</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Extracts an integer from a point for</span></span><br><span class="line"><span class="string">    commitment.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> P.is_zero():</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    x,y = P.xy()</span><br><span class="line"></span><br><span class="line">    s = Integer(x.polynomial().coefficients()[<span class="number">0</span>])</span><br><span class="line">    t = Integer(y.polynomial().coefficients()[<span class="number">0</span>])</span><br><span class="line">    n = s &lt;&lt; (t &amp; <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> n</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">commitment</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">pow</span>(g_commit, x, p_commit)</span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################## Until here</span></span><br><span class="line"></span><br><span class="line">order = h2 * r</span><br><span class="line">factor = [<span class="number">169</span>, <span class="number">23</span> * <span class="number">23</span>, <span class="number">2713</span>, <span class="number">11953</span>, <span class="number">262069</span>]</span><br><span class="line">ff = [<span class="number">13</span> ,<span class="number">23</span>, <span class="number">2713</span>, <span class="number">11953</span>, <span class="number">262069</span>]</span><br><span class="line"></span><br><span class="line">file = <span class="built_in">open</span>(<span class="string">&#x27;magic.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> q, qq <span class="keyword">in</span> <span class="built_in">zip</span>(ff, factor):</span><br><span class="line">    msg = <span class="built_in">hex</span>(order // qq)[<span class="number">2</span>:]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(msg) % <span class="number">2</span>:</span><br><span class="line">        msg = <span class="string">&#x27;0&#x27;</span> + msg</span><br><span class="line">    P = hash_to_point(msg)</span><br><span class="line">    </span><br><span class="line">    ls = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(q):</span><br><span class="line">        Q = P * i</span><br><span class="line">        ls += [<span class="built_in">hex</span>(commitment(point_to_integer(Q)))]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(<span class="built_in">set</span>(ls)) == <span class="built_in">len</span>(ls)</span><br><span class="line">    file.write(<span class="built_in">str</span>(ls))</span><br><span class="line"></span><br><span class="line">file.close()</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">conn = remote(<span class="string">&#x27;crypto.chal.csaw.io&#x27;</span>, <span class="number">5018</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getCancer</span>():</span></span><br><span class="line">    cancer = []</span><br><span class="line">    file = <span class="built_in">open</span>(<span class="string">&#x27;magic.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>).read().replace(<span class="string">&#x27;][&#x27;</span>, <span class="string">&#x27;]\n[&#x27;</span>).split(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> lsString <span class="keyword">in</span> file:</span><br><span class="line">        cancer += [<span class="built_in">eval</span>(lsString)]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cancer</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_json</span>(<span class="params">j</span>):</span></span><br><span class="line">    conn.sendline(json.dumps(j))</span><br><span class="line"></span><br><span class="line">g_commit = <span class="number">0x2</span></span><br><span class="line">p_commit = <span class="number">0x1b1177aadf10a3868443d5b4e6384d914f8c2eb51d1ebec4511d05ed22d8006a65cb4fc0442334e4ad5e2b11cd65cb82efec327d234f034321a818cfc9c71d48f</span></span><br><span class="line"></span><br><span class="line">p = <span class="number">0x1a0111ea397fe69a4b1ba7b6434bacd764774b84f38512bf6730d2a0f6b0f6241eabfffeb153ffffb9feffffffffaaab</span></span><br><span class="line">r = <span class="number">0x73eda753299d7d483339d80809a1d80553bda402fffe5bfeffffffff00000001</span></span><br><span class="line">h1 = <span class="number">0x396c8c005555e1568c00aaab0000aaab</span></span><br><span class="line">h2 = <span class="number">0x5d543a95414e7f1091d50792876a202cd91de4547085abaa68a205b2e5a7ddfa628f1cb4d9e82ef21537e293a6691ae1616ec6e786f0c70cf1c38e31c7238e5</span></span><br><span class="line"></span><br><span class="line">factor = [<span class="number">169</span>, <span class="number">23</span> * <span class="number">23</span>, <span class="number">2713</span>, <span class="number">11953</span>, <span class="number">262069</span>]</span><br><span class="line">ff = [<span class="number">13</span> ,<span class="number">23</span>, <span class="number">2713</span>, <span class="number">11953</span>, <span class="number">262069</span>]</span><br><span class="line">order = h2 * r</span><br><span class="line"></span><br><span class="line"><span class="comment">#####################</span></span><br><span class="line"><span class="comment"># leak info about d #</span></span><br><span class="line"><span class="comment">#####################</span></span><br><span class="line"></span><br><span class="line">cancer = getCancer()</span><br><span class="line">remainder = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> q, qq, magic <span class="keyword">in</span> <span class="built_in">zip</span>(ff, factor, cancer):</span><br><span class="line">    magic = [<span class="built_in">int</span>(x, <span class="number">16</span>) <span class="keyword">for</span> x <span class="keyword">in</span> magic]</span><br><span class="line">    send_json(&#123;<span class="string">&quot;option&quot;</span>: <span class="string">&quot;sign&quot;</span>&#125;)</span><br><span class="line">    conn.recvuntil(<span class="string">b&#x27;Please send your message to sign, encoded as a hex string.&#x27;</span>)</span><br><span class="line">    msg = <span class="built_in">hex</span>(order // qq)[<span class="number">2</span>:]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(msg) % <span class="number">2</span> == <span class="number">1</span>:</span><br><span class="line">        msg = <span class="string">&#x27;0&#x27;</span> + msg</span><br><span class="line">    send_json(&#123;<span class="string">&quot;message&quot;</span>: msg&#125;)</span><br><span class="line"></span><br><span class="line">    conn.recvuntil(<span class="string">b&#x27;Our commitment: &#x27;</span>)</span><br><span class="line">    res = <span class="built_in">int</span>(conn.recvline())</span><br><span class="line">    <span class="built_in">print</span>(q, res)</span><br><span class="line">    <span class="keyword">for</span> i, num <span class="keyword">in</span> <span class="built_in">enumerate</span>(magic):</span><br><span class="line">        <span class="keyword">if</span> num == res:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Found remainder for <span class="subst">&#123;q&#125;</span>: <span class="subst">&#123;i&#125;</span>&quot;</span>)</span><br><span class="line">            remainder += [i]</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################</span></span><br><span class="line"><span class="comment"># merge result to get possible private key d #</span></span><br><span class="line"><span class="comment">##############################################</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crt</span>(<span class="params">ls: <span class="built_in">list</span></span>) -&gt; <span class="built_in">tuple</span>:</span></span><br><span class="line">    rem = <span class="number">0</span></span><br><span class="line">    mod = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> q, r <span class="keyword">in</span> ls:</span><br><span class="line">        gcd = math.gcd(q, mod)</span><br><span class="line">        <span class="keyword">if</span> rem % gcd != r % gcd:</span><br><span class="line">            <span class="keyword">return</span> (-<span class="number">1</span>, -<span class="number">1</span>)</span><br><span class="line">        rem += mod * ((r - rem) // gcd) * <span class="built_in">pow</span>(mod // gcd, -<span class="number">1</span>, q // gcd)</span><br><span class="line">        mod = mod * q // gcd</span><br><span class="line">        rem %= mod</span><br><span class="line">    <span class="keyword">return</span> (mod, rem)</span><br><span class="line"></span><br><span class="line">MOD, _d = crt(<span class="built_in">zip</span>(ff, remainder))</span><br><span class="line"><span class="built_in">print</span>(MOD, _d)</span><br><span class="line"></span><br><span class="line"><span class="comment">#############</span></span><br><span class="line"><span class="comment"># recover d #</span></span><br><span class="line"><span class="comment">#############</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Complex</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, a, b</span>):</span></span><br><span class="line">        <span class="comment"># a + bi</span></span><br><span class="line">        self.a = a</span><br><span class="line">        self.b = b</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__add__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">        <span class="keyword">return</span> Complex((self.a + other.a) % p, (self.b + other.b) % p)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__sub__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">        <span class="keyword">return</span> Complex((self.a - other.a) % p, (self.b - other.b) % p)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__mul__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">        <span class="keyword">return</span> Complex((self.a * other.a - self.b * other.b) % p,</span><br><span class="line">                       (self.a * other.b + self.b * other.a) % p)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.a == other.a <span class="keyword">and</span> self.b == other.b</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inv</span>(<span class="params">self</span>):</span></span><br><span class="line">        iD = <span class="built_in">pow</span>(self.a ** <span class="number">2</span> + self.b ** <span class="number">2</span>, -<span class="number">1</span>, p)</span><br><span class="line">        <span class="keyword">return</span> Complex(self.a * iD % p, -self.b * iD % p)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> Complex(self.a, self.b)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, x, y</span>):</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">toInt</span>(<span class="params">self</span>):</span></span><br><span class="line">        a = self.x.a</span><br><span class="line">        b = self.y.a</span><br><span class="line">        <span class="keyword">return</span> a &lt;&lt; (b &amp; <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__add__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.x == other.x:</span><br><span class="line">            ld = Complex(<span class="number">3</span>, <span class="number">0</span>) * self.x * self.x * Complex(<span class="number">2</span>, <span class="number">0</span>).inv() * self.y.inv()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            ld = (self.y - other.y) * (self.x - other.x).inv()</span><br><span class="line"></span><br><span class="line">        X = ld * ld - self.x - other.x</span><br><span class="line">        Y = ld * (self.x - X) - self.y</span><br><span class="line">        <span class="keyword">return</span> Point(X, Y)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__mul__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">isinstance</span>(other, <span class="built_in">int</span>)</span><br><span class="line">        res = <span class="string">&quot;O&quot;</span></span><br><span class="line">        base = Point(self.x.copy(), self.y.copy())</span><br><span class="line">        <span class="keyword">while</span> other:</span><br><span class="line">            <span class="keyword">if</span> other &amp; <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> res == <span class="string">&quot;O&quot;</span>:</span><br><span class="line">                    res = base</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    res = res + base</span><br><span class="line"></span><br><span class="line">            other &gt;&gt;= <span class="number">1</span></span><br><span class="line">            base = base + base</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> Point(self.x.copy(), self.y.copy())</span><br><span class="line"></span><br><span class="line">msg = <span class="string">&#x27;1234&#x27;</span></span><br><span class="line">G = Point(Complex(<span class="number">567187428662826536704554285744676765709023544078539176084186083325611611492203318998820105838752816922533510370900</span>, <span class="number">60052718657805885678787110624726048385207245407469335866892895204538864185656276944674285324741886152304381844132</span>),</span><br><span class="line">          Complex(<span class="number">700066217685000020766867958173455641165357526414324063897671833856058304658031527688201191640826209508168186734214</span>, <span class="number">445117887577014261707773299476067871930878669778756969958994951630910975535681646923346398743998984509699944220097</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># for the challenge</span></span><br><span class="line">P = Point(Complex(<span class="number">687828580253418521894420198297981230713369955223000071927026438385848317085957422882499556266787416987577543108839</span>, <span class="number">3437849906304030911235272424131970890612194883775766747220678972212370864091554329430600230930083640667800574212878</span>),</span><br><span class="line">          Complex(<span class="number">1246346886386546987103714777226589478759768606505562002158286835891943575613915073704166759835452417743520860031360</span>, <span class="number">93187093546689440062949751687693403958101916426958958600514714210089900938755059872564179426916900362007032903797</span>))</span><br><span class="line"></span><br><span class="line">send_json(&#123;<span class="string">&quot;option&quot;</span>: <span class="string">&quot;sign&quot;</span>&#125;)</span><br><span class="line">conn.recvuntil(<span class="string">b&#x27;Please send your message to sign, encoded as a hex string.&#x27;</span>)</span><br><span class="line">send_json(&#123;<span class="string">&quot;message&quot;</span>: msg&#125;)</span><br><span class="line">conn.recvuntil(<span class="string">b&#x27;Our commitment: &#x27;</span>)</span><br><span class="line">res = <span class="built_in">int</span>(conn.recvline())</span><br><span class="line"></span><br><span class="line">cur_point = G * _d</span><br><span class="line">step = G * MOD</span><br><span class="line">privkey = -<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> d <span class="keyword">in</span> tqdm(<span class="built_in">range</span>(_d, <span class="number">2</span> ** <span class="number">70</span>, MOD)):</span><br><span class="line">    expected = <span class="built_in">pow</span>(g_commit, cur_point.toInt(), p_commit)</span><br><span class="line">    <span class="keyword">if</span> expected == res:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;Found private key d = <span class="subst">&#123;d&#125;</span>&#x27;</span>)</span><br><span class="line">        privkey = d</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    cur_point = cur_point + step</span><br><span class="line"></span><br><span class="line">MAGIC = P * privkey</span><br><span class="line"></span><br><span class="line">Sx0 = MAGIC.x.a</span><br><span class="line">Sx1 = MAGIC.x.b</span><br><span class="line">Sy0 = MAGIC.y.a</span><br><span class="line">Sy1 = MAGIC.y.b</span><br><span class="line"></span><br><span class="line">send_json(&#123;<span class="string">&quot;option&quot;</span>: <span class="string">&quot;verify&quot;</span>&#125;)</span><br><span class="line">challenge = <span class="string">b&quot;https://cryptohack.org&quot;</span></span><br><span class="line">conn.recvuntil(<span class="string">b&quot;Please send the valid signature for our challenge: &#123;challenge&#125;.&quot;</span>)</span><br><span class="line">send_json(&#123;<span class="string">&quot;Sx0&quot;</span>: <span class="built_in">hex</span>(Sx0), <span class="string">&quot;Sx1&quot;</span>: <span class="built_in">hex</span>(Sx1), <span class="string">&quot;Sy0&quot;</span>: <span class="built_in">hex</span>(Sy0), <span class="string">&quot;Sy1&quot;</span>: <span class="built_in">hex</span>(Sy1)&#125;)</span><br><span class="line">conn.interactive()</span><br></pre></td></tr></table></figure>

            </div>

            <!-- Post information -->
            
    <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1 post-tags">
        
            <i class="fas fa-tag" style="vertical-align: middle;font-size: .8rem;"></i>
            tags:&nbsp;
            
            
        
            <a href="/ctf-note/tags/writeup/">#writeup</a>
        
    </div>

            
    <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1">
        <ul class="pagination d-block text-center">
            
                <li class="previous page-item d-inline"><a href="/ctf-note/2021/11/21/BalsnCTF-2021/" class="page-link float-left">&larr;  Newer Posts</a></li>
            
            
                <li class="next page-item d-inline"><a href="/ctf-note/2021/08/22/corCTF-2021/" class="page-link float-right">Older Posts  &rarr;</a></li>
            
        </ul>
    </div>


            
                <!-- Comments -->
                

                

            

        </div>
    </div>
</article> 


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
    <style>
        #toc-content .toc-link::before {
            background-color: transparent;
            max-height: 25px;
        }

        #toc-content .toc-link.is-active-link::before {
            background-color: #404040;
        }
    </style>
    <script src="//cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <div class="ui-toc dropup scrollspy-body pull-right" style="right: 3%;">
        <button type="button" class="toc-btn btn btn-light" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" data-display="static">
            <i class="fas fa-list"></i>
        </button>
        <div class="dropdown-menu dropdown-menu-right p-2"  aria-labelledby="tocLabel">
            <div class="toc-widget">
                <div id="toc-content" class="text-truncate">
                </div>
            </div>
            <div class="toc-menu pt-3 pl-4">
                <a class="expand-toggle d-block py-1" href="#"><span class="expand-text">Expand all</span><span class="close-text" style="display: none;">Collapse all</span></a>
                <a class="back-to-top d-block py-1" href="#">Back to top</a>
                <a class="go-to-bottom d-block py-1" href="#">Go to bottom</a>
            </div>
        </div>
    </div>
    <script>
        tocbot.init({
            // Where to render the table of contents.
            tocSelector: '#toc-content',
            // Where to grab the headings to build the table of contents.
            contentSelector: 'article',
            // Which headings to grab inside of the contentSelector element.
            headingSelector: 'h1, h2, h3',
            // For headings inside relative or absolute positioned containers within content.
            hasInnerContainers: true,
        });
    </script>


    <script src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script>
        MathJax.Hub.Config({
            tex2jax:{inlineMath:[['$', '$']]}
        })
    </script>

    


    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer id="footer">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1 text-center">
                <ul class="list-inline">
                    

                    

                    

                    

                    

                    
                </ul>
                <p class="copyright footer-author">
                    &copy; 2021-2023 
                    <a rel="external" class="copyright-link" href="" target="_blank">Utaha</a><br/>
                    Powered by <a rel="external" class="copyright-link" href="https://hexo.io/" target="_blank">Hexo</a>  
                    <span class="copyright-split">&nbsp;|&nbsp;&nbsp;</span>
                    Theme <a rel="external" class="copyright-link" href="https://github.com/luswdev/hexo-theme-clean.git" target="_blank">Clean</a>
                    
                    
                        <span id="busuanzi_container_site_uv">
                            <span class="copyright-split">&nbsp;|&nbsp;</span>
                            <i class="fas fa-user-friends"></i>&nbsp;&nbsp;<span id="busuanzi_value_site_uv"></span>&nbsp;
                        </span>
                    
                </p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    <!-- jQuery -->
<script src="//cdn.jsdelivr.net/npm/jquery@2.1.4/dist/jquery.min.js"></script>

<!-- For drop down -->
<script src="//cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>

<!-- Bootstrap -->
<script src="//cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js"></script>
<!-- Gallery -->
<script src="//cdn.jsdelivr.net/npm/lightgallery@1.6.11/dist/js/lightgallery-all.min.js"></script>
<!-- Busuanzi -->

    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<!-- Search script -->

<script src="/ctf-note/js/search.js"></script>

<script type="text/javascript">
    $(function () {
        searchFunc( '/ctf-note/search.xml' , 'searchInput', 'searchResult');
    });
</script>



<script src="/ctf-note/js/main.js"></script>



    <!-- Search Modal -->
    <!-- Modal -->
<div class="modal fade" id="searchModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
        <div class="modal-content overflow-auto">
            <div class="modal-header">
                <input type="text" class="form-control" placeholder="Searching Keywords..." id="searchInput">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div id="searchResult">
                    <div class="search-empty text-center text-muted p-5">
                        <i class="far fa-meh"></i>
                    </div>
                </div>
            </div> 
        </div>
    </div>
</div>


</body>
</html>