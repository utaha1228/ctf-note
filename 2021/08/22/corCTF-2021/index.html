<!DOCTYPE html>
<html lang="zh-tw">
<head>
    <meta charset="utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<!--Description-->



    <meta name="description" content="MIT &#39;23, Computer Sceince"/>


<!--Author-->

    <meta name="author" content="Utaha"/>


<!--Open Graph Title-->

    <meta property="og:title" content="corCTF 2021"/>


<!--Open Graph Description-->

    <meta property="og:description" content="MIT &#39;23, Computer Sceince"/>


<!--Open Graph Site Name-->
    <meta property="og:site_name" content="Utaha&#39;s CTF Note"/>

<!--Type page-->

    <meta property="og:type" content="article"/>


<!--Page Cover-->


    <meta property="og:image" content="https://utaha1228.github.io/ctf-note/img/home-bg.jpg"/>


<meta name="twitter:card" content="summary_large_image"/>




    <meta name="twitter:image" content="https://utaha1228.github.io/ctf-note/img/home-bg.jpg"/>


<!-- Title -->

<title>corCTF 2021 | Utaha&#39;s CTF Note</title>

<!-- Bootstrap Core CSS -->
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css">

<!-- Custom CSS -->

<link rel="stylesheet" href="/ctf-note/css/main.css">


<!-- Custom Fonts -->
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.0/css/all.min.css" />
<link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.0/css/all.min.css" />
<link href="//fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
<link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/>

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<!-- Gallery -->
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/featherlight@1.4.0/src/featherlight.css" integrity="sha256-30DV/STftlyQ6v8yaOWlabammvCYtRJERLj/m0b3zno=" crossorigin="anonymous">
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/lightgallery@1.6.11/dist/css/lightgallery.min.css">

<!-- favicon -->

<link rel="icon" href="/ctf-note/img/favicon.png"/>



    <!-- Google Analytics -->
    


<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"></head>
<!-- Head tag -->

<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top bg-transparent position-absolute w-100 p-0" id="nav">
    <div class="container pl-0 pr-0">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <a class="navbar-brand text-white p-1 pl-3" href="/ctf-note/">Utaha's CTF Note</a>
        </div>
        <div>
            <!--  -->
            
                <li class="list-inline-item">
                    <!-- 
                     -->
                    <a class = "navbar-list text-white p-1 pl-3" style = "text-decoration: none;" href="/ctf-note/">
                        
                            Home
                        
                    </a>
                </li>
            
                <li class="list-inline-item">
                    <!-- 
                        <span class="copyright-split">&nbsp;|&nbsp;</span>
                    
                     -->
                    <a class = "navbar-list text-white p-1 pl-3" style = "text-decoration: none;" href="/ctf-note/archives">
                        
                            Archives
                        
                    </a>
                </li>
            
                <li class="list-inline-item">
                    <!-- 
                        <span class="copyright-split">&nbsp;|&nbsp;</span>
                    
                     -->
                    <a class = "navbar-list text-white p-1 pl-3" style = "text-decoration: none;" href="/ctf-note/tags/writeup">
                        
                            Tags
                        
                    </a>
                </li>
            
                <li class="list-inline-item">
                    <!-- 
                        <span class="copyright-split">&nbsp;|&nbsp;</span>
                    
                     -->
                    <a class = "navbar-list text-white p-1 pl-3" style = "text-decoration: none;" href="/ctf-note/about">
                        
                            About
                        
                    </a>
                </li>
            
        </div>
        <div class="navbar-nav float-right">
            <button class="btn btn-link search-btn navbar-item" data-toggle="modal" data-target="#searchModal">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/ctf-note/img/home-bg.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-12 col-md-12 text-center">
                <div class="post-heading text-white">
                    <h1>corCTF 2021</h1>
                    
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <!-- Post Main Content -->
            <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1">
                
                    <span class="meta d-inline-block">
    
    
    <!-- Date -->
    
        <span class="post-meta-split">&nbsp;|&nbsp;</span>
        <i class="far fa-calendar-check fa-fw"></i>
        2021-08-22
    
    <!-- word count and read count -->
    

    

    
        <span class="post-meta-split">&nbsp;|&nbsp;</span>
        <i class="far fa-eye fa-fw"></i>
        <span id="busuanzi_value_page_pv"></span>
    
</span>  
                
                <h2 id="intro">Intro</h2>
<p>There are a total of 12 crypto problems in this CTF, and I solved all of them except 'fried_rice'. I'm going to breifly explain the easier ones, and provide detailed solutions and scripts to the harder ones. The problems are ordered by the number of solves.</p>
<h2 id="babies">Babies</h2>
<h3 id="fibinary">fibinary</h3>
<p>Skipped.</p>
<h3 id="section">4096</h3>
<p>It's an RSA with <span class="math inline">\(N\)</span> being the products of multiple 32-bit primes. We can factorize <span class="math inline">\(N\)</span> by those powerful tools (or even just bruteforce and let the program run for 1.5 hours, which my teammate did) and solve the challenge.</p>
<h3 id="dividing_secrets">dividing_secrets</h3>
<p>The arithmetic operations here are under <span class="math inline">\(Z/pZ\)</span>, and the <span class="math inline">\(p\)</span> is known. We are given <span class="math inline">\(g\)</span> and <span class="math inline">\(g^{flag}\)</span>. We can input at most 64 <span class="math inline">\(div\)</span>, and it tells us <span class="math inline">\(g^{\lfloor \frac{flag}{div} \rfloor}\)</span>.</p>
<p>We can calculate <span class="math inline">\(\left(g^{flag}\right)\left(g^{\lfloor \frac{flag}{div} \rfloor}\right)^{-div} = g^{flag \bmod div}\)</span>, if the chosen <span class="math inline">\(div\)</span> is small enough, we can bruteforce the discrete log, meaning we can retreive the value of <span class="math inline">\(flag \% div\)</span>. Choosing <span class="math inline">\(div\)</span>s to be distinct 20-bit primes (10-bit is probably enough), we can perform CRT to recover the flag.</p>
<h3 id="supercomputer">supercomputer</h3>
<p>This problem is pretty much testing if people know Lifting the Exponent. In this case, since <span class="math inline">\(n = rp^q\)</span> <span class="math display">\[v_p(a_1^n + (n - a_1) ^ n) = v_p(a_0 + (n - a_1)) + v_p(n) = 2q\]</span> with an exception of <span class="math inline">\(p \mid a_1\)</span>, which is really unlikely to happen.</p>
<h3 id="babyrsa">babyrsa</h3>
<p>It's a classic coppersmith. <a target="_blank" rel="noopener" href="https://eprint.iacr.org/2020/1506.pdf">Recommend reading</a> (4.2.2 ~ 4.2.4 for this specific challenge).</p>
<h3 id="babypad">babypad</h3>
<p>Classic padding oracle.</p>
<h3 id="babyrand">babyrand</h3>
<p>Given <span class="math inline">\(p\)</span>, <span class="math inline">\(x &lt; p\)</span>, we have to recover <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span> by <span class="math inline">\((ax+b) \bmod p\)</span>, where <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span> are both an approximation of <span class="math inline">\(p \oplus x\)</span>, formally, <span class="math inline">\(|a - (p \oplus x)| &lt; 2^{200}\)</span> while <span class="math inline">\(p\)</span> is a 512-bit prime (and <span class="math inline">\(x\)</span> is randomly chosen).</p>
<p>Let <span class="math inline">\(a&#39; = a - (p \oplus x)\)</span> and <span class="math inline">\(b&#39; = b - (p\oplus x)\)</span>, by some math, we can get <span class="math inline">\((a&#39;x+b&#39;) \bmod p\)</span> from <span class="math inline">\((ax+b) \bmod p\)</span>. Now transform this into a closest vector problem (CVP): consider the lattice <span class="math display">\[\begin{pmatrix}
x &amp; 1 \\
p &amp; 1 \\
\end{pmatrix}\]</span> and find the closest vector to <span class="math inline">\((a&#39;x+b \bmod p, 0)\)</span>. Multiply the first row by <span class="math inline">\(a\)</span>, and subtract by the second row multiplied by <span class="math inline">\(\lfloor \frac{ax}{p} \rfloor\)</span> should be really close, so we can recover <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span> by solving the CVP. (Be aware that multiply the second row by <span class="math inline">\(\lceil \frac{ax}{p} \rceil\)</span> is also a possibility, but can be handled in a similar way)</p>
<h3 id="bank">bank</h3>
<p>We can measure and apply some gates to control the qubit to the place we want (no matter where the initial position is). Combining it with powerful 'verify' operation, we can check if the bill is a '0' by moving the qubit to '0' and measure. We believe that it is a '0' if it is verified 10 times in a row. Similarly, apply this to '1', '+', and '-'. Therefore, we can recover the bill.</p>
<h3 id="leave_it_to_chance">leave_it_to_chance</h3>
<p>The arithmetic operations here are under <span class="math inline">\(Z/pZ\)</span>, and the <span class="math inline">\(p = 4k + 1\)</span> is known. Let the root of <span class="math inline">\(p \mid x^4 - 1\)</span> be <span class="math inline">\(\pm 1,\pm a\)</span>. The problem provides a signing oracle, where the signature of <span class="math inline">\(x\)</span> is <span class="math inline">\(f(x)^4\)</span> and <span class="math inline">\(f\)</span> is a polynomial with degree <span class="math inline">\(31\)</span>. As there are four possible <span class="math inline">\(f(x)\)</span>, while signing, we also get hints that two out of the 4 possible value is not the actual <span class="math inline">\(f(x)\)</span> (these two numbers are chosen randomly among the three fake ones).</p>
<p>First, notice that <span class="math inline">\(f(x)^4\)</span> is also a polynomial, but with degree <span class="math inline">\(124\)</span>, so we can ask for <span class="math inline">\(124\)</span> signatures and get <span class="math inline">\(f(x)^4\)</span> with Guassian elimination. Then square root <span class="math inline">\(f(x)^4\)</span> twice to get a possible <span class="math inline">\(f(x)\)</span>. To square root a polynomial, we need tonelli-shank to get the first coefficient, and the rest is <a target="_blank" rel="noopener" href="https://math.stackexchange.com/questions/324385/algorithm-for-finding-the-square-root-of-a-polynomial">simple math</a>. After getting the possible <span class="math inline">\(f(x)\)</span>, the other 3 possibilities are <span class="math inline">\(-f(x)\)</span>, <span class="math inline">\(af(x)\)</span>, <span class="math inline">\(-af(x)\)</span>. We can use the hints to eliminate the fake ones, until only one is left.</p>
<p>Credits to <a target="_blank" rel="noopener" href="https://gist.github.com/nakov/60d62bdf4067ea72b7832ce9f71ae079">nakov</a> for the tonelli-shank implementation <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">&#x27;crypto.be.ax&#x27;</span>, <span class="number">6001</span>)</span><br><span class="line">r.recvuntil(<span class="string">b&#x27;p = &#x27;</span>)</span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line">p = <span class="built_in">int</span>(r.recvline().decode(<span class="string">&#x27;ascii&#x27;</span>))</span><br><span class="line"></span><br><span class="line">debug = []</span><br><span class="line">matrix = []</span><br><span class="line"></span><br><span class="line">magic = <span class="number">125</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(magic + <span class="number">1</span>):</span><br><span class="line">	coe = [<span class="built_in">pow</span>(t, i, p) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(magic)]</span><br><span class="line">	r.recvuntil(<span class="string">b&#x27;Choice&gt;&#x27;</span>)</span><br><span class="line">	r.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">	r.sendline(<span class="built_in">hex</span>(t)[<span class="number">2</span>:])</span><br><span class="line">	r.recvuntil(<span class="string">b&#x27;Signature: &#x27;</span>)</span><br><span class="line">	coe.append(<span class="built_in">int</span>(r.recvline().decode(<span class="string">&#x27;ascii&#x27;</span>), <span class="number">16</span>))</span><br><span class="line">	r.sendline(<span class="string">b&#x27;0&#x27;</span>)</span><br><span class="line">	<span class="keyword">if</span> t &lt; magic: matrix.append(coe[:])</span><br><span class="line">	debug.append(coe[:])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Guassian Elimination&quot;</span>)</span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(matrix) == magic</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(magic):</span><br><span class="line">	<span class="keyword">if</span> matrix[i][i] == <span class="number">0</span>:</span><br><span class="line">		<span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i + <span class="number">1</span>, magic):</span><br><span class="line">			<span class="keyword">if</span> matrix[j][i] != <span class="number">0</span>:</span><br><span class="line">				matrix[i], matrix[j] = matrix[j], matrix[i]</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">	inv = <span class="built_in">pow</span>(matrix[i][i], -<span class="number">1</span>, p)</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(magic + <span class="number">1</span>):</span><br><span class="line">		matrix[i][j] = matrix[i][j] * inv % p</span><br><span class="line">	<span class="keyword">assert</span> matrix[i][i] == <span class="number">1</span></span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i + <span class="number">1</span>, magic):</span><br><span class="line">		coe = matrix[j][i]</span><br><span class="line">		<span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(magic + <span class="number">1</span>):</span><br><span class="line">			matrix[j][k] = (matrix[j][k] - coe * matrix[i][k]) % p</span><br><span class="line"></span><br><span class="line">		<span class="keyword">assert</span> matrix[j][i] == <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(magic - <span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i):</span><br><span class="line">		coe = matrix[j][i]</span><br><span class="line">		<span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(magic + <span class="number">1</span>):</span><br><span class="line">			matrix[j][k] = (matrix[j][k] - coe * matrix[i][k]) % p</span><br><span class="line"></span><br><span class="line">poly = [matrix[i][-<span class="number">1</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(magic)]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(magic + <span class="number">1</span>):</span><br><span class="line">	s = <span class="built_in">sum</span>(x * y <span class="keyword">for</span> x, y <span class="keyword">in</span> <span class="built_in">zip</span>(debug[i], poly)) % p</span><br><span class="line">	<span class="keyword">assert</span> s == debug[i][-<span class="number">1</span>], <span class="string">f&quot;<span class="subst">&#123;i&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;square root the poly&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modular_sqrt</span>(<span class="params">a, p</span>):</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">legendre_symbol</span>(<span class="params">a, p</span>):</span></span><br><span class="line">		<span class="string">&quot;&quot;&quot; Compute the Legendre symbol a|p using</span></span><br><span class="line"><span class="string">			Euler&#x27;s criterion. p is a prime, a is</span></span><br><span class="line"><span class="string">			relatively prime to p (if p divides</span></span><br><span class="line"><span class="string">			a, then a|p = 0)</span></span><br><span class="line"><span class="string">			Returns 1 if a has a square root modulo</span></span><br><span class="line"><span class="string">			p, -1 otherwise.</span></span><br><span class="line"><span class="string">		&quot;&quot;&quot;</span></span><br><span class="line">		ls = <span class="built_in">pow</span>(a, (p - <span class="number">1</span>) // <span class="number">2</span>, p)</span><br><span class="line">		<span class="keyword">return</span> -<span class="number">1</span> <span class="keyword">if</span> ls == p - <span class="number">1</span> <span class="keyword">else</span> ls</span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;&quot;&quot; Find a quadratic residue (mod p) of &#x27;a&#x27;. p</span></span><br><span class="line"><span class="string">		must be an odd prime.</span></span><br><span class="line"><span class="string">		Solve the congruence of the form:</span></span><br><span class="line"><span class="string">			x^2 = a (mod p)</span></span><br><span class="line"><span class="string">		And returns x. Note that p - x is also a root.</span></span><br><span class="line"><span class="string">		0 is returned is no square root exists for</span></span><br><span class="line"><span class="string">		these a and p.</span></span><br><span class="line"><span class="string">		The Tonelli-Shanks algorithm is used (except</span></span><br><span class="line"><span class="string">		for some simple cases in which the solution</span></span><br><span class="line"><span class="string">		is known from an identity). This algorithm</span></span><br><span class="line"><span class="string">		runs in polynomial time (unless the</span></span><br><span class="line"><span class="string">		generalized Riemann hypothesis is false).</span></span><br><span class="line"><span class="string">	&quot;&quot;&quot;</span></span><br><span class="line">	<span class="comment"># Simple cases</span></span><br><span class="line">	<span class="comment">#</span></span><br><span class="line">	<span class="keyword">if</span> legendre_symbol(a, p) != <span class="number">1</span>:</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">	<span class="keyword">elif</span> a == <span class="number">0</span>:</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">	<span class="keyword">elif</span> p == <span class="number">2</span>:</span><br><span class="line">		<span class="keyword">return</span> p</span><br><span class="line">	<span class="keyword">elif</span> p % <span class="number">4</span> == <span class="number">3</span>:</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">pow</span>(a, (p + <span class="number">1</span>) // <span class="number">4</span>, p)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># Partition p-1 to s * 2^e for an odd s (i.e.</span></span><br><span class="line">	<span class="comment"># reduce all the powers of 2 from p-1)</span></span><br><span class="line">	<span class="comment">#</span></span><br><span class="line">	s = p - <span class="number">1</span></span><br><span class="line">	e = <span class="number">0</span></span><br><span class="line">	<span class="keyword">while</span> s % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">		s //= <span class="number">2</span></span><br><span class="line">		e += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># Find some &#x27;n&#x27; with a legendre symbol n|p = -1.</span></span><br><span class="line">	<span class="comment"># Shouldn&#x27;t take long.</span></span><br><span class="line">	<span class="comment">#</span></span><br><span class="line">	n = <span class="number">2</span></span><br><span class="line">	<span class="keyword">while</span> legendre_symbol(n, p) != -<span class="number">1</span>:</span><br><span class="line">		n += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># Here be dragons!</span></span><br><span class="line">	<span class="comment"># Read the paper &quot;Square roots from 1; 24, 51,</span></span><br><span class="line">	<span class="comment"># 10 to Dan Shanks&quot; by Ezra Brown for more</span></span><br><span class="line">	<span class="comment"># information</span></span><br><span class="line">	<span class="comment">#</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># x is a guess of the square root that gets better</span></span><br><span class="line">	<span class="comment"># with each iteration.</span></span><br><span class="line">	<span class="comment"># b is the &quot;fudge factor&quot; - by how much we&#x27;re off</span></span><br><span class="line">	<span class="comment"># with the guess. The invariant x^2 = ab (mod p)</span></span><br><span class="line">	<span class="comment"># is maintained throughout the loop.</span></span><br><span class="line">	<span class="comment"># g is used for successive powers of n to update</span></span><br><span class="line">	<span class="comment"># both a and b</span></span><br><span class="line">	<span class="comment"># r is the exponent - decreases with each update</span></span><br><span class="line">	<span class="comment">#</span></span><br><span class="line">	x = <span class="built_in">pow</span>(a, (s + <span class="number">1</span>) // <span class="number">2</span>, p)</span><br><span class="line">	b = <span class="built_in">pow</span>(a, s, p)</span><br><span class="line">	g = <span class="built_in">pow</span>(n, s, p)</span><br><span class="line">	r = e</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">		t = b</span><br><span class="line">		m = <span class="number">0</span></span><br><span class="line">		<span class="keyword">for</span> m <span class="keyword">in</span> <span class="built_in">range</span>(r):</span><br><span class="line">			<span class="keyword">if</span> t == <span class="number">1</span>:</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			t = <span class="built_in">pow</span>(t, <span class="number">2</span>, p)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> m == <span class="number">0</span>:</span><br><span class="line">			<span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">		gs = <span class="built_in">pow</span>(g, <span class="number">2</span> ** (r - m - <span class="number">1</span>), p)</span><br><span class="line">		g = (gs * gs) % p</span><br><span class="line">		x = (x * gs) % p</span><br><span class="line">		b = (b * g) % p</span><br><span class="line">		r = m</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">poly_square_root</span>(<span class="params">poly</span>):</span></span><br><span class="line">	ret = [modular_sqrt(poly[<span class="number">0</span>], p)]</span><br><span class="line">	deg = (<span class="built_in">len</span>(poly) - <span class="number">1</span>) // <span class="number">2</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, deg + <span class="number">1</span>):</span><br><span class="line">		cur = poly[i]</span><br><span class="line">		<span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, i):</span><br><span class="line">			cur -= ret[j] * ret[i - j]</span><br><span class="line">		cur %= p</span><br><span class="line">		cur = cur * <span class="built_in">pow</span>(<span class="number">2</span> * ret[<span class="number">0</span>], -<span class="number">1</span>, p) % p</span><br><span class="line">		ret.append(cur)</span><br><span class="line">	<span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">poly = poly_square_root(poly)</span><br><span class="line">poly = poly_square_root(poly)</span><br><span class="line">a = modular_sqrt(p - <span class="number">1</span>, p)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;time to find the actual poly&#x27;</span>)</span><br><span class="line"></span><br><span class="line">possible = [<span class="number">1</span>, -<span class="number">1</span> % p, a, -a % p]</span><br><span class="line"></span><br><span class="line">message = <span class="number">8787</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">len</span>(possible) &gt; <span class="number">1</span>:</span><br><span class="line">	r.recvuntil(<span class="string">b&#x27;Choice&gt;&#x27;</span>)</span><br><span class="line">	r.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">	r.sendline(<span class="built_in">hex</span>(message)[<span class="number">2</span>:])</span><br><span class="line">	r.sendline(<span class="string">b&#x27;0&#x27;</span>)</span><br><span class="line">	r.recvuntil(<span class="string">b&#x27;Hints: &#x27;</span>)</span><br><span class="line">	hints = r.recvline().split(<span class="string">b&#x27; &#x27;</span>)</span><br><span class="line">	<span class="comment"># print(f&quot;debug: &#123;hints&#125;&quot;)</span></span><br><span class="line">	hints = [<span class="built_in">int</span>(x.decode(<span class="string">&#x27;ascii&#x27;</span>)) <span class="keyword">for</span> x <span class="keyword">in</span> hints]</span><br><span class="line">	my_guess = <span class="built_in">sum</span>(<span class="built_in">pow</span>(message, i, p) * x <span class="keyword">for</span> i, x <span class="keyword">in</span> <span class="built_in">enumerate</span>(poly)) % p</span><br><span class="line">	hints = [x * <span class="built_in">pow</span>(my_guess, -<span class="number">1</span>, p) % p <span class="keyword">for</span> x <span class="keyword">in</span> hints]</span><br><span class="line">	<span class="keyword">if</span> hints[<span class="number">0</span>] <span class="keyword">in</span> possible:</span><br><span class="line">		possible.remove(hints[<span class="number">0</span>])</span><br><span class="line">	<span class="keyword">if</span> hints[<span class="number">1</span>] <span class="keyword">in</span> possible:</span><br><span class="line">		possible.remove(hints[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">	message += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;actual poly found&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(poly)):</span><br><span class="line">	poly[i] = (poly[i] * possible[<span class="number">0</span>]) % p</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">b&#x27;Choice&gt; &#x27;</span>)</span><br><span class="line">r.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">b&#x27;space-separated numbers&gt; &#x27;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27; &#x27;</span>.join([<span class="built_in">str</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> poly]))</span><br><span class="line"><span class="built_in">print</span>(r.recvline())</span><br></pre></td></tr></table></figure></p>
<h2 id="non-babies">Non-Babies</h2>
<h3 id="lcg-k">LCG-k</h3>
<p>We are given a typical signing oracle, but the <span class="math inline">\(k\)</span> is generated by LCG with coefficient <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span>. We are allowed to sign 4 messages, and have to find the private key.</p>
<p>Let's say we sign 4 messages <span class="math inline">\(m_1\)</span>, <span class="math inline">\(m_2\)</span>, <span class="math inline">\(m_3\)</span>, and <span class="math inline">\(m_4\)</span>, we have</p>
<p><span class="math display">\[s_i = \frac{1}{k_i}(H(m_i) + dr_i)\]</span></p>
<p>and</p>
<p><span class="math display">\[k_2 = ak_1 + b, k_3 = a(ak_1+b) + b, k_4 = a(a(ak_1+b) + b) + b\]</span></p>
<p>The unknowns are <span class="math inline">\(a\)</span>, <span class="math inline">\(b\)</span>, <span class="math inline">\(k\)</span>, and <span class="math inline">\(d\)</span>. As we have 4 equations, we really have the chance to solve it! First we move the terms a little bit</p>
<p><span class="math display">\[k_i = \frac{H(m_i) + dr_i}{s_i}\]</span></p>
<p>the idea is that <span class="math inline">\(k_i\)</span> is the LCG output, so it's better to not put it in denominator. Also, the right hand side has only an unknown <span class="math inline">\(d\)</span>. Now we have</p>
<p><span class="math display">\[k_{i + 1} - k_{i} = \frac{H(m_{i + 1}) + dr_{i+1}}{s_{i+1}} - \frac{H(m_i) + dr_i}{s_i}\]</span></p>
<p>No matter how ugly the right hand side looks, it is just <span class="math inline">\(\alpha d + \beta\)</span> for some constant <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span>. The reason we do this is because for the left hand side, we have</p>
<p><span class="math display">\[\frac{k_{i + 1} - k_i}{k_i - k_{i - 1}} = a\]</span></p>
<p>by the idea that <span class="math inline">\(k\)</span> is exponentially growing regardless of <span class="math inline">\(b\)</span>. Therefore, by</p>
<p><span class="math display">\[\frac{k_4 - k_3}{k_3 - k_2} = \frac{k_3 - k_2}{k_2 - k_1}\]</span></p>
<p>or</p>
<p><span class="math display">\[(k_3 - k_2) ^ 2 = (k_4 - k_3)(k_2 - k_1)\]</span></p>
<p>We derived a quadratic equation for <span class="math inline">\(d\)</span>. As the modulo is a prime number, we can solve the equation with tonelli-shank.</p>
<h3 id="mystery_stream">mystery_stream</h3>
<p>In this problem, we need to decrypt ciphertext that is encrypted by a LFSR stream cipher (the problem use GF(256) instead of xor, but it is not really important). The key generation process hinted that the output of LFSR is periodic, though the period is unknown. This reminds me of Vignere Cipher, but the period can be big, and the trick mentioned in <a target="_blank" rel="noopener" href="https://cryptopals.com/sets/1/challenges/6">cryptopals</a> probably won't work (after solving, it turned out that bruteforce the period is do-able), so here we made some observation based on generating function.</p>
<p>Let the output bits of LFSR be <span class="math inline">\(b_0, b_1, \cdots, b_n, \cdots\)</span>. Consider the polynomial (the coefficient is in <span class="math inline">\(GF(2)\)</span> so <span class="math inline">\(-x\)</span> is the same as <span class="math inline">\(x\)</span>)</p>
<p><span class="math display">\[b_0 + b_1x + b_2x^2 + c\dots = \frac{g(x)}{f(x)}\]</span></p>
<p>where <span class="math inline">\(f(x)\)</span> is the LFSR polynomial. To find the period <span class="math inline">\(t\)</span>, it must satisfy</p>
<p><span class="math display">\[\frac{g(x)}{f(x)} = \frac{h(x)}{1 + x^t}\]</span></p>
<p>so we can factorize <span class="math inline">\(f(x)\)</span> and looks for the suitable <span class="math inline">\(t\)</span>. It turned out that <span class="math inline">\(t = 255\)</span> and <span class="math inline">\(gcd(f(x), 1 + x^{255}) = x^8 + \cdots\)</span>. Therefore, <span class="math inline">\(g(x)\)</span> needs to cancel out all other <span class="math inline">\(f(x)\)</span> factors other than <span class="math inline">\(x^8 + \cdot\)</span>. Now we know that <span class="math inline">\(g(x)\)</span> has a degree-56 factor (<span class="math inline">\(f\)</span> has degree 64), as <span class="math inline">\(g(x)\)</span> has degree at most 63, there's only 256 possible <span class="math inline">\(g(x)\)</span>. A <span class="math inline">\(g(x)\)</span> means a key, after bruteforcing the key, we can recover the plaintext.</p>

            </div>

            <!-- Post information -->
            
    <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1 post-tags">
        
            <i class="fas fa-tag" style="vertical-align: middle;font-size: .8rem;"></i>
            tags:&nbsp;
            
            
        
            <a href="/ctf-note/tags/writeup/">#writeup</a>
        
    </div>

            
    <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1">
        <ul class="pagination d-block text-center">
            
            
                <li class="next page-item d-inline"><a href="/ctf-note/2021/08/10/Closest-Vector-Problem/" class="page-link float-right">Older Posts  &rarr;</a></li>
            
        </ul>
    </div>


            
                <!-- Comments -->
                

                

            

        </div>
    </div>
</article> 


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
    <style>
        #toc-content .toc-link::before {
            background-color: transparent;
            max-height: 25px;
        }

        #toc-content .toc-link.is-active-link::before {
            background-color: #404040;
        }
    </style>
    <script src="//cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <div class="ui-toc dropup scrollspy-body pull-right" style="right: 3%;">
        <button type="button" class="toc-btn btn btn-light" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" data-display="static">
            <i class="fas fa-list"></i>
        </button>
        <div class="dropdown-menu dropdown-menu-right p-2"  aria-labelledby="tocLabel">
            <div class="toc-widget">
                <div id="toc-content" class="text-truncate">
                </div>
            </div>
            <div class="toc-menu pt-3 pl-4">
                <a class="expand-toggle d-block py-1" href="#"><span class="expand-text">Expand all</span><span class="close-text" style="display: none;">Collapse all</span></a>
                <a class="back-to-top d-block py-1" href="#">Back to top</a>
                <a class="go-to-bottom d-block py-1" href="#">Go to bottom</a>
            </div>
        </div>
    </div>
    <script>
        tocbot.init({
            // Where to render the table of contents.
            tocSelector: '#toc-content',
            // Where to grab the headings to build the table of contents.
            contentSelector: 'article',
            // Which headings to grab inside of the contentSelector element.
            headingSelector: 'h1, h2, h3',
            // For headings inside relative or absolute positioned containers within content.
            hasInnerContainers: true,
        });
    </script>


    <script src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script>
        MathJax.Hub.Config({
            tex2jax:{inlineMath:[['$', '$']]}
        })
    </script>

    


    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer id="footer">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1 text-center">
                <ul class="list-inline">
                    

                    

                    

                    

                    

                    
                </ul>
                <p class="copyright footer-author">
                    &copy; 2021-2021 
                    <a rel="external" class="copyright-link" href="" target="_blank">Utaha</a><br/>
                    Powered by <a rel="external" class="copyright-link" href="https://hexo.io/" target="_blank">Hexo</a>  
                    <span class="copyright-split">&nbsp;|&nbsp;&nbsp;</span>
                    Theme <a rel="external" class="copyright-link" href="https://github.com/luswdev/hexo-theme-clean.git" target="_blank">Clean</a>
                    
                    
                        <span id="busuanzi_container_site_uv">
                            <span class="copyright-split">&nbsp;|&nbsp;</span>
                            <i class="fas fa-user-friends"></i>&nbsp;&nbsp;<span id="busuanzi_value_site_uv"></span>&nbsp;
                        </span>
                    
                </p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    <!-- jQuery -->
<script src="//cdn.jsdelivr.net/npm/jquery@2.1.4/dist/jquery.min.js"></script>

<!-- For drop down -->
<script src="//cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>

<!-- Bootstrap -->
<script src="//cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js"></script>
<!-- Gallery -->
<script src="//cdn.jsdelivr.net/npm/lightgallery@1.6.11/dist/js/lightgallery-all.min.js"></script>
<!-- Busuanzi -->

    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<!-- Search script -->

<script src="/ctf-note/js/search.js"></script>

<script type="text/javascript">
    $(function () {
        searchFunc( '/ctf-note/search.xml' , 'searchInput', 'searchResult');
    });
</script>



<script src="/ctf-note/js/main.js"></script>



    <!-- Search Modal -->
    <!-- Modal -->
<div class="modal fade" id="searchModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
        <div class="modal-content overflow-auto">
            <div class="modal-header">
                <input type="text" class="form-control" placeholder="Searching Keywords..." id="searchInput">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div id="searchResult">
                    <div class="search-empty text-center text-muted p-5">
                        <i class="far fa-meh"></i>
                    </div>
                </div>
            </div> 
        </div>
    </div>
</div>


</body>
</html>